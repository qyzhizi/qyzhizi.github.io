<!doctype html><html lang=zh-cn data-theme=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.112.5"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Opencv Canny 源码解析"><meta itemprop=description content="opencv-canny-源码解析"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/imgs/2001_big_icons.png"><meta itemprop=keywords content="opencv,c++"><meta property="og:type" content="article"><meta property="og:title" content="Opencv Canny 源码解析"><meta property="og:description" content="opencv-canny-源码解析"><meta property="og:image" content="/imgs/2001_big_icons.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/opencv-canny-source-code-analysis.html"><meta property="og:site_name" content="log"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Hollis"><meta property="article:published_time" content="2023-07-03 19:21:43 +0800 CST"><meta property="article:modified_time" content="2023-07-03 19:21:43 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.8b63813f6d971d6efc075de818d178312c142a542313b8ac1b773085bbc915ef.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"opencv-canny-source-code-analysis.html","permalink":"/opencv-canny-source-code-analysis.html","title":"Opencv Canny 源码解析","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><title>Opencv Canny 源码解析 - log</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏 role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>log</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>programming</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-flinks"><a href=/flinks.html class=hvr-icon-pulse rel=section><i class="fa fa-thumbs-up hvr-icon"></i>站点示例</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>17</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-RSS"><a href=/rss.xml class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>RSS</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#canny函数接口>canny函数接口</a></li><li><a href=#cvcanny函数签名>cvCanny函数签名</a></li><li><a href=#获取梯度图>获取梯度图</a></li><li><a href=#环形缓存区与边缘点缓存map>环形缓存区与边缘点缓存(map)</a></li><li><a href=#极大值抑制边缘点入栈>极大值抑制，边缘点入栈</a></li><li><a href=#滞后阈值>滞后阈值</a></li><li><a href=#构造最后的边缘图片>构造最后的边缘图片</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Hollis src=/imgs/img-lazy-loading.gif data-src=/imgs/2001_big_icons.png><p class=site-author-name itemprop=name>Hollis</p><div class=site-description itemprop=description>share something</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>17</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>2</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>34</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/qyzhizi title="Github → https://github.com/qyzhizi" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>Github</a></span>
<span class=links-of-social-item><a href=https://twitter.com/qyzhizi title="Twitter → https://twitter.com/qyzhizi" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-twitter fa-fw hvr-icon"></i>Twitter</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://lisenhui.cn title=https://lisenhui.cn target=_blank>凡梦星尘空间站</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2022-06-03T11:52:18+08:00></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=31683></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=74></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2023-07-07T15:04:16+08:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/qyzhizi rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/opencv-canny-source-code-analysis.html><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/2001_big_icons.png"><meta itemprop=name content="Hollis"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Hollis"><meta itemprop=description content="share something"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Opencv Canny 源码解析"><meta itemprop=description content="opencv-canny-源码解析"></span><header class=post-header><h1 class=post-title itemprop="name headline">Opencv Canny 源码解析
<a href=https://github.com/qyzhizi/hugo-blog/tree/main/content/post/opencv-canny-%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text>发表于：</span>
<time title="发表于：2023-07-03 19:21:43 +0800 CST" itemprop="dateCreated datePublished" datetime="2023-07-03 19:21:43 +0800 CST">2023-07-03</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text>分类于：</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/programming itemprop=url rel=index><span itemprop=name>programming</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span><span>3180</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>7分钟</span></span>
<span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>浏览：</span>
<span class=waline-pageview-count data-path=/opencv-canny-source-code-analysis.html><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>void</span> cv<span style=color:#f92672>::</span>Canny( <span style=color:#66d9ef>const</span> Mat<span style=color:#f92672>&amp;</span> image, Mat<span style=color:#f92672>&amp;</span> edges,
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>double</span> threshold1, <span style=color:#66d9ef>double</span> threshold2,
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> apertureSize, <span style=color:#66d9ef>bool</span> L2gradient )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Mat src <span style=color:#f92672>=</span> image;
</span></span><span style=display:flex><span>    edges.create(src.size(), CV_8U);
</span></span><span style=display:flex><span>    CvMat _src <span style=color:#f92672>=</span> src, _dst <span style=color:#f92672>=</span> edges;
</span></span><span style=display:flex><span>    cvCanny( <span style=color:#f92672>&amp;</span>_src, <span style=color:#f92672>&amp;</span>_dst, threshold1, threshold2,
</span></span><span style=display:flex><span>        apertureSize <span style=color:#f92672>+</span> (L2gradient <span style=color:#f92672>?</span> CV_CANNY_L2_GRADIENT : <span style=color:#ae81ff>0</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里使用的代码是opencv 2.2 版本的代码，也是最早的代码，与最新版本的代码相比，基本思想不变，最重要的是代码结构简单，是最容易理解的版本。 本文主要是对代码进行了行间注释，解释canny 算法的c++实现细节。</p><p>阅读前提：</p><ul><li>已经理解canny 算法的基本原理，包括sobel 算子获取梯度图，canny 算法使用的极大值抑制与滞后阈值。</li><li>希望了解opencv 的c++ 算法实现。</li></ul><p>源码地址：https://github.com/opencv/opencv/blob/2.2/modules/imgproc/src/canny.cpp</p><h2 id=canny函数接口>canny函数接口</h2><p>canny函数 调用了cvCanny， cvCanny 是主要的函数。
默认计算梯度幅值，使用L1范数，如果使用L2范数，实际的sobel 算子 大小= <code>apertureSize + CV_CANNY_L2_GRADIENT</code> 。<code>CV_CANNY_L2_GRADIENT</code> 的值为16</p><p>为了减少计算复杂度，使用L1范数更快。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>void</span> cv<span style=color:#f92672>::</span>Canny( <span style=color:#66d9ef>const</span> Mat<span style=color:#f92672>&amp;</span> image, Mat<span style=color:#f92672>&amp;</span> edges,
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>double</span> threshold1, <span style=color:#66d9ef>double</span> threshold2,
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> apertureSize, <span style=color:#66d9ef>bool</span> L2gradient )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Mat src <span style=color:#f92672>=</span> image;
</span></span><span style=display:flex><span>    edges.create(src.size(), CV_8U);
</span></span><span style=display:flex><span>    CvMat _src <span style=color:#f92672>=</span> src, _dst <span style=color:#f92672>=</span> edges;
</span></span><span style=display:flex><span>    cvCanny( <span style=color:#f92672>&amp;</span>_src, <span style=color:#f92672>&amp;</span>_dst, threshold1, threshold2,
</span></span><span style=display:flex><span>        apertureSize <span style=color:#f92672>+</span> (L2gradient <span style=color:#f92672>?</span> CV_CANNY_L2_GRADIENT : <span style=color:#ae81ff>0</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=cvcanny函数签名>cvCanny函数签名</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span>CV_IMPL <span style=color:#66d9ef>void</span> cvCanny( <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> srcarr, <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> dstarr,
</span></span><span style=display:flex><span>                      <span style=color:#66d9ef>double</span> low_thresh, <span style=color:#66d9ef>double</span> high_thresh,
</span></span><span style=display:flex><span>                      <span style=color:#66d9ef>int</span> aperture_size )
</span></span></code></pre></div><p><code>CV_IMPL</code>: 这是一个宏定义，值为：<code>extern "C"</code>, 在 C++ 中，函数名会被编译器进行符号重载，即会根据函数参数的类型和数量生成不同的符号名。然而，C 函数没有符号重载的概念，因此在 C++ 代码中调用 C 函数时，需要使用 <code>extern "C"</code> 来告诉编译器使用 C 的链接规则来编译和链接这个函数。这样可以保证 C++ 代码和 C 代码之间的函数调用正确地进行。</p><p>cvCanny 函数的参数：</p><ul><li><p><code>srcarr</code>: 输入图片的指针</p></li><li><p><code>dstarr</code>: 保存输出图片的指针</p></li><li><p><code>low_thresh</code>: 低阈值，在cvCanny函数中，有一个步骤叫做极大值抑制，它处理的是梯度幅值图（稍后解释），其中它会将低于阈值的像素标记为非边缘，注意极大值抑制不止是标记像素，极大值抑制还有很多其他的步骤, 这里只是稍微解释<code>low_thresh</code>参数的一点含义。</p></li><li><p><code>high_thresh</code>: 高阈值,同理,Canny算法处理过程中,会将高于该值的像素标记轮廓,而处于低阈值与高阈值中间的值标记为弱轮廓。注意:canny 算法最后输出的轮廓点包含:轮廓点与经过滞后阈值(稍后解释)的弱轮廓点.</p></li><li><p><code>aperture_size</code>: sobel kernel size，一般是3x3的矩阵，soebel算法是为了得到梯度图。</p></li></ul><p>接下来都是cvCanny函数的实现细节</p><h2 id=获取梯度图>获取梯度图</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>// get the src size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>size <span style=color:#f92672>=</span> cvGetMatSize( src );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// horizontal gradient
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>dx <span style=color:#f92672>=</span> cvCreateMat( size.height, size.width, CV_16SC1 );
</span></span><span style=display:flex><span><span style=color:#75715e>// vertical gradient
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>dy <span style=color:#f92672>=</span> cvCreateMat( size.height, size.width, CV_16SC1 );
</span></span><span style=display:flex><span><span style=color:#75715e>// get the horizontal gradient
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>cvSobel( src, dx, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>, aperture_size );
</span></span><span style=display:flex><span><span style=color:#75715e>// get the vertical gradient
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>cvSobel( src, dy, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, aperture_size );
</span></span></code></pre></div><h2 id=环形缓存区与边缘点缓存map>环形缓存区与边缘点缓存(map)</h2><p>定义了3个缓存区：<code>mag_buf[0]</code>， <code>mag_buf[1]</code>， <code>mag_buf[2]</code>，之所以说它们是环形缓存区后面再解释。
边缘点缓存(map)，是用于保存轮廓点映射，在极大值抑制与滞后阈值中会使用，后面再具体解释。</p><p>这里贴出了代码，并进行了较为详细注释。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>// allocates buffer, because 2 padding added, so size.width and size.height should add 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>buffer.allocate( (size.width<span style=color:#f92672>+</span><span style=color:#ae81ff>2</span>)<span style=color:#f92672>*</span>(size.height<span style=color:#f92672>+</span><span style=color:#ae81ff>2</span>) <span style=color:#f92672>+</span> (size.width<span style=color:#f92672>+</span><span style=color:#ae81ff>2</span>)<span style=color:#f92672>*</span><span style=color:#ae81ff>3</span><span style=color:#f92672>*</span><span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>int</span>) );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// First convert it to a char* type, and then convert it to an int* type.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>mag_buf[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int</span><span style=color:#f92672>*</span>)(<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span>)buffer;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// mag_buf[1] points to the second gradient cache, and the width is increased by 2 here because the gradient map needs to be padded with 1 on the left and right sides.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>mag_buf[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> mag_buf[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>+</span> size.width <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Similarly, mag_buf[2] points to the third cache.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>mag_buf[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> mag_buf[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> size.width <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Get the end position of the mag_buf[2] cache and then convert it to a uchar* type. The area pointed to by the pointer will be used for mapping contour points in the future. The mapped values ​​are 0, 1, and 2, which represent  weak contour, non-contour, and strong contour, respectively.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>map <span style=color:#f92672>=</span> (uchar<span style=color:#f92672>*</span>)(mag_buf[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>+</span> size.width <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// represents map area width
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>mapstep <span style=color:#f92672>=</span> size.width <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 1 &lt;&lt; 10 represents 1024
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>maxsize <span style=color:#f92672>=</span> MAX( <span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>10</span>, size.width<span style=color:#f92672>*</span>size.height<span style=color:#f92672>/</span><span style=color:#ae81ff>10</span> );
</span></span><span style=display:flex><span><span style=color:#75715e>// the stack is used to restore strong contour points, and the stack used for Hysteresis threshold
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>stack.resize( maxsize );
</span></span><span style=display:flex><span><span style=color:#75715e>// &amp;stack[0] is the stack[0] pointer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>stack_top <span style=color:#f92672>=</span> stack_bottom <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>stack[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// mag_buf[0] is the first gradient cache, and (size.width+2)*sizeof(int) bytes is set 0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>memset( mag_buf[<span style=color:#ae81ff>0</span>], <span style=color:#ae81ff>0</span>, (size.width<span style=color:#f92672>+</span><span style=color:#ae81ff>2</span>)<span style=color:#f92672>*</span><span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>int</span>) );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Consider the area pointed by th map pointer. the area&#39;s fisrt row and last row set to 1 which represents non-contour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>memset( map, <span style=color:#ae81ff>1</span>, mapstep );
</span></span><span style=display:flex><span>memset( map <span style=color:#f92672>+</span> mapstep<span style=color:#f92672>*</span>(size.height <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>), <span style=color:#ae81ff>1</span>, mapstep );
</span></span></code></pre></div><h2 id=极大值抑制边缘点入栈>极大值抑制，边缘点入栈</h2><p>入栈与出栈宏定义：d 代表着 轮廓点的地址。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>#define CANNY_PUSH(d)    *(d) = (uchar)2, *stack_top++ = (d)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define CANNY_POP(d)     (d) = *--stack_top
</span></span></span></code></pre></div><p>接下来继续介绍实现细节，这里贴出了代码，并进行了较为详细注释。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>// calculate magnitude and angle of gradient, perform non-maxima supression.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// fill the map with one of the following values:
</span></span></span><span style=display:flex><span><span style=color:#75715e>//   0 - the pixel might belong to an edge
</span></span></span><span style=display:flex><span><span style=color:#75715e>//   1 - the pixel can not belong to an edge
</span></span></span><span style=display:flex><span><span style=color:#75715e>//   2 - the pixel does belong to an edge
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>for</span>( i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;=</span> size.height; i<span style=color:#f92672>++</span> )
</span></span><span style=display:flex><span>{    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// get the latest mag_buf, firstly is mag_buf[1], later is magbuf[2]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span><span style=color:#f92672>*</span> _mag <span style=color:#f92672>=</span> mag_buf[(i <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// there float and int have same bytes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>float</span><span style=color:#f92672>*</span> _magf <span style=color:#f92672>=</span> (<span style=color:#66d9ef>float</span><span style=color:#f92672>*</span>)_mag;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// get dx i-th row pointer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>short</span><span style=color:#f92672>*</span> _dx <span style=color:#f92672>=</span> (<span style=color:#66d9ef>short</span><span style=color:#f92672>*</span>)(dx<span style=color:#f92672>-&gt;</span>data.ptr <span style=color:#f92672>+</span> dx<span style=color:#f92672>-&gt;</span>step<span style=color:#f92672>*</span>i);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// get dy i-th row pointer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>short</span><span style=color:#f92672>*</span> _dy <span style=color:#f92672>=</span> (<span style=color:#66d9ef>short</span><span style=color:#f92672>*</span>)(dy<span style=color:#f92672>-&gt;</span>data.ptr <span style=color:#f92672>+</span> dy<span style=color:#f92672>-&gt;</span>step<span style=color:#f92672>*</span>i);
</span></span><span style=display:flex><span>    uchar<span style=color:#f92672>*</span> _map;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> x, y;
</span></span><span style=display:flex><span>    ptrdiff_t magstep1, magstep2;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// in the same row , if The previous one pixel belong to an edge, then the flag is 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> prev_flag <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>( i <span style=color:#f92672>&lt;</span> size.height )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// in i-th row, first and last pixel set to 0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        _mag[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> _mag[size.width] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>( <span style=color:#f92672>!</span>(flags <span style=color:#f92672>&amp;</span> CV_CANNY_L2_GRADIENT) )
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span>( j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;</span> size.width; j<span style=color:#f92672>++</span> )
</span></span><span style=display:flex><span>                <span style=color:#75715e>// calculate the magnitude 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                _mag[j] <span style=color:#f92672>=</span> abs(_dx[j]) <span style=color:#f92672>+</span> abs(_dy[j]);
</span></span><span style=display:flex><span>        <span style=color:#75715e>/*else if( icvFilterSobelVert_8u16s_C1R_p != 0 ) // check for IPP
</span></span></span><span style=display:flex><span><span style=color:#75715e>        {
</span></span></span><span style=display:flex><span><span style=color:#75715e>            // use vectorized sqrt
</span></span></span><span style=display:flex><span><span style=color:#75715e>            mag_row.data.fl = _magf;
</span></span></span><span style=display:flex><span><span style=color:#75715e>            for( j = 0; j &lt; size.width; j++ )
</span></span></span><span style=display:flex><span><span style=color:#75715e>            {
</span></span></span><span style=display:flex><span><span style=color:#75715e>                x = _dx[j]; y = _dy[j];
</span></span></span><span style=display:flex><span><span style=color:#75715e>                _magf[j] = (float)((double)x*x + (double)y*y);
</span></span></span><span style=display:flex><span><span style=color:#75715e>            }
</span></span></span><span style=display:flex><span><span style=color:#75715e>            cvPow( &amp;mag_row, &amp;mag_row, 0.5 );
</span></span></span><span style=display:flex><span><span style=color:#75715e>        }*/</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span>( j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;</span> size.width; j<span style=color:#f92672>++</span> )
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                x <span style=color:#f92672>=</span> _dx[j]; y <span style=color:#f92672>=</span> _dy[j];
</span></span><span style=display:flex><span>                _magf[j] <span style=color:#f92672>=</span> (<span style=color:#66d9ef>float</span>)std<span style=color:#f92672>::</span>sqrt((<span style=color:#66d9ef>double</span>)x<span style=color:#f92672>*</span>x <span style=color:#f92672>+</span> (<span style=color:#66d9ef>double</span>)y<span style=color:#f92672>*</span>y);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// when reach the bottom, padding 0 to magbuf[2]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        memset( _mag<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>, (size.width <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>)<span style=color:#f92672>*</span><span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>int</span>) );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// at the very beginning we do not have a complete ring
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// buffer of 3 magnitude rows for non-maxima suppression
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span>( i <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// get pointer in map which point to i-th row and 1 col pixel. add one is because padding 1 in map
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    _map <span style=color:#f92672>=</span> map <span style=color:#f92672>+</span> mapstep<span style=color:#f92672>*</span>i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// first and last pixel set 1 which means non-contour or non-edge
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    _map[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> _map[size.width] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// the central row , previous is mag_buf[0] the next one is mag_buf[2]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    _mag <span style=color:#f92672>=</span> mag_buf[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>; <span style=color:#75715e>// take the central row
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// get the previous row pointer  of dx , the current one is i-th row, but the (i-1)-th row perform non-maxima supression
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    _dx <span style=color:#f92672>=</span> (<span style=color:#66d9ef>short</span><span style=color:#f92672>*</span>)(dx<span style=color:#f92672>-&gt;</span>data.ptr <span style=color:#f92672>+</span> dx<span style=color:#f92672>-&gt;</span>step<span style=color:#f92672>*</span>(i<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>    _dy <span style=color:#f92672>=</span> (<span style=color:#66d9ef>short</span><span style=color:#f92672>*</span>)(dy<span style=color:#f92672>-&gt;</span>data.ptr <span style=color:#f92672>+</span> dy<span style=color:#f92672>-&gt;</span>step<span style=color:#f92672>*</span>(i<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// calculate distance, magstep1 is the distance next row to current row in the   same col。magstep2 is current row to previous row in the same col
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    magstep1 <span style=color:#f92672>=</span> mag_buf[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>-</span> mag_buf[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    magstep2 <span style=color:#f92672>=</span> mag_buf[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>-</span> mag_buf[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>( (stack_top <span style=color:#f92672>-</span> stack_bottom) <span style=color:#f92672>+</span> size.width <span style=color:#f92672>&gt;</span> maxsize )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> sz <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int</span>)(stack_top <span style=color:#f92672>-</span> stack_bottom);
</span></span><span style=display:flex><span>        maxsize <span style=color:#f92672>=</span> MAX( maxsize <span style=color:#f92672>*</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>, maxsize <span style=color:#f92672>+</span> <span style=color:#ae81ff>8</span> );
</span></span><span style=display:flex><span>        stack.resize(maxsize);
</span></span><span style=display:flex><span>        stack_bottom <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>stack[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>        stack_top <span style=color:#f92672>=</span> stack_bottom <span style=color:#f92672>+</span> sz;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span>( j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;</span> size.width; j<span style=color:#f92672>++</span> )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>#define CANNY_SHIFT 15
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// TG22 is Integer type, it is convenient for calculation, represent 22.5 degrees
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>#define TG22  (int)(0.4142135623730950488016887242097*(1&lt;&lt;CANNY_SHIFT) + 0.5)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        x <span style=color:#f92672>=</span> _dx[j];
</span></span><span style=display:flex><span>        y <span style=color:#f92672>=</span> _dy[j];
</span></span><span style=display:flex><span>        <span style=color:#75715e>// if x and y are same sign s = 1, else s = 0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>int</span> s <span style=color:#f92672>=</span> x <span style=color:#f92672>^</span> y;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> m <span style=color:#f92672>=</span> _mag[j];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        x <span style=color:#f92672>=</span> abs(x);
</span></span><span style=display:flex><span>        y <span style=color:#f92672>=</span> abs(y);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>( m <span style=color:#f92672>&gt;</span> low )
</span></span><span style=display:flex><span>        {   
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> tg22x <span style=color:#f92672>=</span> x <span style=color:#f92672>*</span> TG22;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> tg67x <span style=color:#f92672>=</span> tg22x <span style=color:#f92672>+</span> ((x <span style=color:#f92672>+</span> x) <span style=color:#f92672>&lt;&lt;</span> CANNY_SHIFT);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            y <span style=color:#f92672>&lt;&lt;=</span> CANNY_SHIFT;
</span></span><span style=display:flex><span>            <span style=color:#75715e>// y &lt; tg22x represent angle of gradient more than (360-22.5)) degrees and less than 22.5 degrees. more than (180-22.5) degrees and less than (180+22.5) degrees
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span>( y <span style=color:#f92672>&lt;</span> tg22x )
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Compare magnitude in the 0-degree direction
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span>( m <span style=color:#f92672>&gt;</span> _mag[j<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>&amp;&amp;</span> m <span style=color:#f92672>&gt;=</span> _mag[j<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>] )
</span></span><span style=display:flex><span>                {    
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// !prev_flag and _map[j-mapstep]!= 2 make nearby pixels Both are edges， It reduces the workload of hysteresis threshold.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span>( m <span style=color:#f92672>&gt;</span> high <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>prev_flag <span style=color:#f92672>&amp;&amp;</span> _map[j<span style=color:#f92672>-</span>mapstep] <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> )
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// push postion of (_map+j) into stack, it is edges, it will set 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        CANNY_PUSH( _map <span style=color:#f92672>+</span> j );
</span></span><span style=display:flex><span>                        prev_flag <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// maybe a edge
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        _map[j] <span style=color:#f92672>=</span> (uchar)<span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// if prev_flag == 1,  next time !prev_flag != 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#75715e>// y &gt; tg67x represent angle of gradient more than (90-22.5) degrees less than (90+22.5) degrees. more than (270-22.5) degress and less (270+22.5) degrees.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span>( y <span style=color:#f92672>&gt;</span> tg67x )
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Compare magnitude in the 90-degree direction
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span>( m <span style=color:#f92672>&gt;</span> _mag[j<span style=color:#f92672>+</span>magstep2] <span style=color:#f92672>&amp;&amp;</span> m <span style=color:#f92672>&gt;=</span> _mag[j<span style=color:#f92672>+</span>magstep1] )
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span>( m <span style=color:#f92672>&gt;</span> high <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>prev_flag <span style=color:#f92672>&amp;&amp;</span> _map[j<span style=color:#f92672>-</span>mapstep] <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> )
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        CANNY_PUSH( _map <span style=color:#f92672>+</span> j );
</span></span><span style=display:flex><span>                        prev_flag <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                        _map[j] <span style=color:#f92672>=</span> (uchar)<span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// when s == -1, represent angle of gradient  is between the [135-22.5, 135+22.5] or [315-22.5, 315+22.5]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// when s == 1, represent angle of gradient  is between the [45-22.5, 45+22.5] or [225-22.5, 225+22.5]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            {
</span></span><span style=display:flex><span>                s <span style=color:#f92672>=</span> s <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>?</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Compare magnitude in the 45-degree or 135-degree direction
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span>( m <span style=color:#f92672>&gt;</span> _mag[j<span style=color:#f92672>+</span>magstep2<span style=color:#f92672>-</span>s] <span style=color:#f92672>&amp;&amp;</span> m <span style=color:#f92672>&gt;</span> _mag[j<span style=color:#f92672>+</span>magstep1<span style=color:#f92672>+</span>s] )
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span>( m <span style=color:#f92672>&gt;</span> high <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>prev_flag <span style=color:#f92672>&amp;&amp;</span> _map[j<span style=color:#f92672>-</span>mapstep] <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> )
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        CANNY_PUSH( _map <span style=color:#f92672>+</span> j );
</span></span><span style=display:flex><span>                        prev_flag <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                        _map[j] <span style=color:#f92672>=</span> (uchar)<span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// this loop no edge, set flag 0 , so next time !prev_flag will be true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        prev_flag <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 1 represent not a edge
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        _map[j] <span style=color:#f92672>=</span> (uchar)<span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// scroll the ring buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    _mag <span style=color:#f92672>=</span> mag_buf[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>    mag_buf[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> mag_buf[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    mag_buf[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> mag_buf[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>    mag_buf[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> _mag;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>极大值抑制采用了循环缓存，分别是<code>mag_buf[0]</code> <code>mag_buf[1]</code> <code>mag_buf[2]</code>， 并会进行循环移动，保证<code>mag_buf[1]</code>是用来执行极大值抑制的行。
并在边缘梯度周围补0，这个解释了 一开始<code>mag_buf[0]</code> 设置为0， 循环到最后时，<code>mag_buf[2]</code>也设置为0
另外缓存的第一个元素与最后一个元素都是0。</p><p><code>!prev_flag && _map[j-mapstep] != 2</code> 这个判断上次循环已经当前列的上一行是否已经存在边缘，如果存在，那么这个位置的像素就不算边缘，这样可以减少滞后阈值的计算量，因为滞后阈值会判断当前像素的周围是否标记为0的像素，如果存在，那么也记为边缘。为了减少重复计算，这里极大值抑制就通过这种方式减少了入栈的像素，以此来减少计算量。</p><p>这里判断梯度方向时，会将梯度方向判定为<code>[0, 45, 90, 135]</code>之一，用如下图表示：
<img src=/imgs/img-lazy-loading.gif data-src=https://qyzhizi.cn/img/202307031852659.png alt></p><h2 id=滞后阈值>滞后阈值</h2><p>滞后阈值的的作用是将一些可能是边缘点的像素设置为边缘点，这可以连接一些间断了的边缘，提高边缘检测的鲁棒性。</p><p>滞后阈值的代码比较简短，主要是将边缘点出栈，然后判断改点8个方向上是否存在标记为0的边缘点，如果存在，那么该点也入栈，并标记为边缘点，一直到栈为空。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// now track the edges (hysteresis thresholding)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>while</span>( stack_top <span style=color:#f92672>&gt;</span> stack_bottom )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    uchar<span style=color:#f92672>*</span> m;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>( (stack_top <span style=color:#f92672>-</span> stack_bottom) <span style=color:#f92672>+</span> <span style=color:#ae81ff>8</span> <span style=color:#f92672>&gt;</span> maxsize )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> sz <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int</span>)(stack_top <span style=color:#f92672>-</span> stack_bottom);
</span></span><span style=display:flex><span>        maxsize <span style=color:#f92672>=</span> MAX( maxsize <span style=color:#f92672>*</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>, maxsize <span style=color:#f92672>+</span> <span style=color:#ae81ff>8</span> );
</span></span><span style=display:flex><span>        stack.resize(maxsize);
</span></span><span style=display:flex><span>        stack_bottom <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>stack[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>        stack_top <span style=color:#f92672>=</span> stack_bottom <span style=color:#f92672>+</span> sz;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    CANNY_POP(m);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>( <span style=color:#f92672>!</span>m[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] )
</span></span><span style=display:flex><span>        CANNY_PUSH( m <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>( <span style=color:#f92672>!</span>m[<span style=color:#ae81ff>1</span>] )
</span></span><span style=display:flex><span>        CANNY_PUSH( m <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>( <span style=color:#f92672>!</span>m[<span style=color:#f92672>-</span>mapstep<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] )
</span></span><span style=display:flex><span>        CANNY_PUSH( m <span style=color:#f92672>-</span> mapstep <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>( <span style=color:#f92672>!</span>m[<span style=color:#f92672>-</span>mapstep] )
</span></span><span style=display:flex><span>        CANNY_PUSH( m <span style=color:#f92672>-</span> mapstep );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>( <span style=color:#f92672>!</span>m[<span style=color:#f92672>-</span>mapstep<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>] )
</span></span><span style=display:flex><span>        CANNY_PUSH( m <span style=color:#f92672>-</span> mapstep <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>( <span style=color:#f92672>!</span>m[mapstep<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] )
</span></span><span style=display:flex><span>        CANNY_PUSH( m <span style=color:#f92672>+</span> mapstep <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>( <span style=color:#f92672>!</span>m[mapstep] )
</span></span><span style=display:flex><span>        CANNY_PUSH( m <span style=color:#f92672>+</span> mapstep );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>( <span style=color:#f92672>!</span>m[mapstep<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>] )
</span></span><span style=display:flex><span>        CANNY_PUSH( m <span style=color:#f92672>+</span> mapstep <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=构造最后的边缘图片>构造最后的边缘图片</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>// the final pass, form the final image
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>for</span>( i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> size.height; i<span style=color:#f92672>++</span> )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> uchar<span style=color:#f92672>*</span> _map <span style=color:#f92672>=</span> map <span style=color:#f92672>+</span> mapstep<span style=color:#f92672>*</span>(i<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    uchar<span style=color:#f92672>*</span> _dst <span style=color:#f92672>=</span> dst<span style=color:#f92672>-&gt;</span>data.ptr <span style=color:#f92672>+</span> dst<span style=color:#f92672>-&gt;</span>step<span style=color:#f92672>*</span>i;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span>( j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;</span> size.width; j<span style=color:#f92672>++</span> )
</span></span><span style=display:flex><span>        _dst[j] <span style=color:#f92672>=</span> (uchar)<span style=color:#f92672>-</span>(_map[j] <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>_map[j]</code> 如果是0， <code>(_map[j] >> 1)</code> 还是0， <code>-(_map[j] >> 1)</code> 是0， <code>(uchar)-(_map[j] >> 1)</code> 是0
<code>_map[j]</code> 如果是1，<code>(_map[j] >> 1)</code> 还是0，<code>-(_map[j] >> 1)</code> 是0， <code>(uchar)-(_map[j] >> 1)</code> 是0
<code>_map[j]</code> 如果是2，<code>(_map[j] >> 1)</code> 是1，<code>-(_map[j] >> 1)</code> 是-1， <code>(uchar)-(_map[j] >> 1)</code> 是255</p><p>所以只有标记为2的像素会以225的值输出。</p></div><footer class=post-footer><div class=post-tags><a href=/tags/opencv>opencv</a>
<a href=/tags/c++>c++</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=reward-container><div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div><button>赞赏</button><div class=post-reward></div></div><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right><ul><li class=post-copyright-title><strong>文章标题：</strong>
Opencv Canny 源码解析</li><li class=post-copyright-author><strong>原文作者：</strong>
Hollis</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=/opencv-canny-source-code-analysis.html title="Opencv Canny 源码解析">/opencv-canny-source-code-analysis.html</a></li><li class=post-copyright-license><strong>版权声明：</strong>
本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/images/wechat_channel.jpg><span class=icon><i class="fab fa-weixin"></i></span>
<span class=label>WeChat</span></a></div><div class=social-item><a target=_blank class=social-link href=/rss.xml><span class=icon><i class="fa fa-rss"></i></span>
<span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/pytorch-implement-opencv-canny-algorithm.html rel=next title="PyTorch 实现 Opencv Canny 算法"><i class="fa fa-chevron-left"></i> PyTorch 实现 Opencv Canny 算法</a></div><div class="post-nav-prev post-nav-item"><a href=/pytorch-dataloader.html rel=prev title="PyTorch DataLoader的工作机制">PyTorch DataLoader的工作机制
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>Hollis</span></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.4.1","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.37028fbafbd97fd89808b4c7b5a3a81f01ed0ab24001d273d774f9546a0e9170.js defer></script></body></html>